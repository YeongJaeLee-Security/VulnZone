<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@page import="java.io.PrintWriter"%>
<%@page import="ExploitsUtil.Captcha"%>
<%@page import="ExploitsParam.CaptchaParams"%>
<%@ page import="java.util.UUID"%>
<%@ page import="utils.Utils"%>
<%@ include file="../common/commonLevel.jsp"%>
<%
String csrfToken = UUID.randomUUID().toString();
Captcha captcha = new Captcha();

boolean isRecaptchaEnabled = captcha.isRecaptchaEnable();
%>

<!DOCTYPE html>
<html>
<head>
    <jsp:include page="../common/commonHead.jsp" />
</head>
<body>
    <jsp:include page="../common/commonHeader.jsp" />
    <%@ include file="../common/commonExploitsNavigation.jsp"%>

    <div class="container">
        <h2>
            Insecure CAPTCHA: <em style="color: red;"><%=currentLevel%></em>
        </h2>

        <div class="col-sm-8 col-md-8">
            <div class="jumbotron">
                <%
                if (isRecaptchaEnabled) {
                    PrintWriter script = response.getWriter();
                    String step = request.getParameter("step");
                    String passNew = request.getParameter("newPassword");
                    String passConf = request.getParameter("newPasswordConfirm");

                    if (request.getParameter("change") != null && (step == null || step.equals("1"))) {
                        if (passNew == null || passNew.trim().isEmpty() || passConf == null || passConf.trim().isEmpty()) {
                            Utils.presentAlert(script, "비밀번호는 알파벳 대소문자, 숫자, 특수문자를 포함한 8~20 글자여야 합니다.");
                            Utils.location(script, "captcha.jsp");
                            return;
                        }

                        String recaptchaResponse = request.getParameter("g-recaptcha-response");
                        String currentUser = (String) session.getAttribute("userID");

                        CaptchaParams captchaParams = new CaptchaParams(step, passNew, passConf, recaptchaResponse, null, currentUser, csrfToken);
                        String result = currentLevel.equalsIgnoreCase("easy") ? captcha.low(captchaParams) : captcha.hard(captchaParams);

                        if (result != null) {
                            // Step 1 완료 -> Step 2로 전환 (기존 폼 숨기고 새로운 폼 표시)
                            out.println("<div>" + result + "</div>");
                            return;
                        } else {
                        	Utils.presentAlert(script, "비밀번호는 알파벳 대소문자, 숫자, 특수문자를 포함한 8~20 글자여야 합니다.");
                            Utils.location(script, "captcha.jsp");
                            return;
                        }
                    }

                    if (step != null && step.equals("2")) {
                        // Step 2: 최종 비밀번호 변경
                        String recaptchaResponse = request.getParameter("g-recaptcha-response");
                        String passedCaptcha = request.getParameter("passed_captcha");
                        String currentUser = (String) session.getAttribute("userID");

                        CaptchaParams captchaParams = new CaptchaParams(step, passNew, passConf, recaptchaResponse, passedCaptcha, currentUser, csrfToken);
                        String result = currentLevel.equalsIgnoreCase("easy") ? captcha.low(captchaParams) : captcha.hard(captchaParams);

                        out.println("<pre style='color: red;'>" + result + "</pre>");
                        return;
                    }
                %>
                <!-- Step 1: 기본 폼 -->
                <form action="#" method="POST">
                    <input type="hidden" name="step" value="1">
                    <h3 style="text-align: center;">Change your password</h3>

                    <div class="form-group" style="margin-top: 30px;">
                        <input type="password" class="form-control" placeholder="새 비밀번호"
                               name="newPassword" maxlength="20" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <input type="password" class="form-control" placeholder="새 비밀번호 확인"
                               name="newPasswordConfirm" maxlength="20" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <script src="https://www.google.com/recaptcha/api.js"></script>
                    </div>
                    
                    <div class="g-recaptcha"
                         data-sitekey="<%=captcha.getRecaptchaPublicKey()%>">
                    </div>
                    <input type="hidden" name="user_token" value="<%=csrfToken%>">
                    
                    <input type="submit" style="margin-top: 20px;"
                           class="btn btn-primary form-control" value="change" name="change">
                </form>
                <%
                } else {
                %>
                <pre>
                    <em style="color: red;"><b>Please register for a key</b></em> reCAPTCHA : <a
                        href="https://www.google.com/recaptcha/admin/create"
                        target="_blank">https://www.google.com/recaptcha/admin/create</a>
                </pre>
                <%
                }
                %>
            </div>
        </div>
    </div>

    <%@ include file="../common/commonFooter.jsp"%>
</body>
</html>